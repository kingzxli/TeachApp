<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.song.mapper.SelectTeaMapper">

	
	<resultMap type="com.song.pojo.SelectTea" id="resultMap">
		<id column="id" property="id"/>
		<result column="address" property="address"/>
		<result column="detailed" property="detailed"/>
		<result column="other_require" property="otherrequire"/>
		<result column="stu_situation" property="stusituation"/>
		<result column="tea_require" property="tearequire"/>
		<result column="stu_sex" property="stusex"/>
		<result column="tea_sex" property="teasex"/>
		<result column="stu_message" property="stumessage"/>
		<result column="culture" property="culture"/>
		<result column="grade" property="grade"/>
		<result column="subject" property="subject"/>
		<result column="tea_type" property="teatype"/>
		<result column="trial" property="trial"/>
		<result column="phone" property="phone"/>
		<result column="goclass" property="goclass"/>
		<result column="school" property="school"/>
		<result column="addtime" property="addtime"/>
		<result column="pstatus" property="pstatus"/>
		<result column="teachingType" property="teachingType"/>
		<result column="latlng" property="latlng"/>
<!-- 		<association property="parent" javaType="Parent">
			<result column="name" property="name"/>
		</association>
 -->	</resultMap>


	<select id="selectBySids" resultType="com.song.pojo.SelectTea">
		select * from select_tea where delstatus = 0 and id = #{sid}
	</select>

	<select id="selectBySid2" resultType="com.song.pojo.SelectTea">
		select * from select_tea where delstatus = 0 and id = #{sid}
	</select>

	<select id="SelectTea" resultType="com.song.pojo.Teacher">
		select t.* from selecttea s,teacher t where s.topenid = t.openid and pid =#{pid} and s.status=1
	</select>
	
	<select id="SelectStu" resultType="com.song.pojo.Parent">
		select p.name,st.grade,st.subject,st.address,st.detailed,st.goclass,st.trial from selecttea s,parent p,select_tea st where s.pid = p.id and s.sid = st.id and s.tid =#{tid} and s.status=1 and st.delstatus = 0
	</select>

	<insert id="add" parameterType="com.song.pojo.SelectTea" useGeneratedKeys="true" keyProperty="id">
		insert into select_tea 
		(latlng,latitude,teachingType,popenid,addtime,school,goclass,stu_id,phone,address,detailed,other_require,stu_situation,tea_require,stu_sex,tea_sex,stu_message,culture,grade,subject,tea_type,trial,way) 
		values
		 (#{latlng},#{latitude},#{teachingType},#{popenid},#{addtime},#{school},#{goclass},#{stuid},#{phone},#{address},#{detailed},#{otherrequire},#{stusituation},#{tearequire},#{stusex},#{teasex},#{stumessage},#{culture},#{grade},#{subject},#{teatype},#{trial},#{way})
	</insert>
	
	<select id="selectByType" parameterType="com.song.pojo.SelectTea" resultType="com.song.pojo.SelectTea">
		select id,stu_id,subject,address,detailed,grade,popenid,latlng from select_tea where tea_type=#{tea_type} and pstatus != 1 and delstatus = 0
		<if test="address != null and address != ''">
			and address=#{address}
		</if>
		<if test="project != null and project !=''">
			and subject =#{project}
		</if>
		<if test="tea_sex !=null and tea_sex !=''">
			and tea_sex = #{tea_sex}
		</if>
	</select>
	
	<select id="selectAll" parameterType="com.song.pojo.SelectTea" resultMap="resultMap">
		select teachingType,id,stu_id,subject,address,detailed,grade,popenid from select_tea where pstatus != 1 and delstatus = 0
		<if test="address != null and address != ''">
			and address=#{address}
		</if>
		<if test="project != null and project !=''">
			and subject =#{project}
		</if>
		<if test="tea_sex !=null and tea_sex !=''">
			and tea_sex = #{tea_sex}
		</if>
	</select>

	<select id="selectById" resultType="com.song.pojo.SelectTea" >
		select * from select_tea s where stu_id = #{id} and delstatus = 0
	</select>
	
	<delete id="delete" >
		delete from select_tea where id = #{id}
	</delete>
	
	<select id="selectId" resultType="com.song.pojo.SelectTea" >
		select * from select_tea where id = #{id} and delstatus = 0
	</select>
	
	
	<insert id="addTeaSel" parameterType="com.song.pojo.TeaSelect">
		insert into selecttea (topenid,sid,addtime,tid,pid) values (#{topenid},#{sid},#{addtime},#{tid},#{pid})
	</insert>
	
	
	<select id="selectByPid" resultType="com.song.pojo.TeaSelect">
		select st.tid,st.topenid,st.addtime,st.id,st.sid,t.image,t.name,s.grade,s.subject,st.status,st.pid
		from select_tea s,teacher t,selecttea st where t.openid = st.topenid and s.id = st.sid
		and st.status = 0  and s.delstatus = 0
		and st.sid in (select id from select_tea where stu_id = #{pid});
	</select>
	
	
	<select id="selectByTopenid" resultType="com.song.pojo.TeaSelect">
		select st.tid,s.id,s.grade,s.subject,s.culture,s.address,s.detailed,st.status from select_tea s,selecttea st 
		where s.delstatus = 0  and s.id = st.sid and st.topenid = #{openid}
	</select>
	
	<update id="updateStatus" >
		update selecttea set status=#{status} where id=#{id}
	</update>
	
	<update id="updatePstatus" >
		update select_tea set pstatus=#{status} where id=#{id}
	</update>
	
	<select id="selectStuta" parameterType="com.song.pojo.TeaSelect" resultType="com.song.pojo.TeaSelect">
		select * from selecttea where sid=#{sid} and topenid=#{openid}
	</select>
	
	<select id="selectBySid" resultType="java.lang.String">
		select topenid from selecttea where status=0 and sid=#{sid} and id !=#{id}
	</select>
	
	<delete id="deleteSt" >
		delete from selecttea where sid = #{id}	and tid = #{tid}
	</delete>
	
	<select id="selectSt"  resultType="com.song.pojo.TeaSelect">
		select * from selecttea where sid = #{id}
	</select>
	
	<select id="selectAllDate" resultType="com.song.pojo.SelectTea">
		select * from select_tea where latitude is null
	</select>
	
	<update id="updateById" parameterType="com.song.pojo.SelectTea">
		update select_tea set latlng=#{latlng},latitude = #{latitude} where id=#{id}
	</update>
	
	<select id="selectByType2" parameterType="com.song.pojo.SelectTeaVo" resultType="com.song.pojo.SelectTeaVo">
		select 
			id,
			stu_id,
			subject,
			address,
			detailed,
			grade,
			popenid,
			(  
			    6371 * acos (  
			      cos ( radians(#{latitude}) )  
			      * cos( radians( latitude ) )  
			      * cos( radians( latlng ) - radians(#{latlng}) )  
			      + sin ( radians(#{latitude}) )  
			      * sin( radians( latitude ) )  
			    )  
			  ) AS distance 
		from select_tea 
		where 
		pstatus != 1 
		and delstatus = 0
		<if test="teatype != null and teatype != ''">
			and tea_type=#{teatype} 
		</if>
		<if test="address != null and address != ''">
			and address=#{address}
		</if>
		<if test="subject != null and subject !=''">
			and subject =#{subject}
		</if>
		<if test="teasex !=null and teasex !=''">
			and tea_sex = #{teasex}
		</if>
		ORDER BY distance	
	</select>
	
	<update id="updateStatusNo" >
		update selecttea set status= 2 where id != #{id}
	</update>
</mapper>